<!-- 樣板統計表格 -->
<div class="overflow-x-auto" x-data="summaryTable()">
    <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
            <tr>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-12">
                    展開
                </th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    類型
                </th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    次數
                </th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    平均執行時間
                </th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    使用表格
                </th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    樣板 SQL
                </th>
            </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
            {% for row in data %}
            <tr class="hover:bg-gray-50 transition-colors">
                <!-- 展開按鈕 -->
                <td class="px-6 py-4 whitespace-nowrap text-center">
                    <button @click="toggleRow({{ loop.index0 }})" class="text-gray-400 hover:text-gray-600 focus:outline-none" aria-label="展開或收合行詳細資料">
                        <i :class="expandedRows.includes({{ loop.index0 }}) ? 'fas fa-chevron-down' : 'fas fa-chevron-right'" class="text-sm"></i>
                    </button>
                </td>
                
                <!-- SQL 類型 -->
                <td class="px-6 py-4 whitespace-nowrap">
                    {% if row.type == 'SELECT' %}
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                            <i class="fas fa-search mr-1"></i>SELECT
                        </span>
                    {% elif row.type == 'INSERT' %}
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                            <i class="fas fa-plus mr-1"></i>INSERT
                        </span>
                    {% elif row.type == 'UPDATE' %}
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                            <i class="fas fa-edit mr-1"></i>UPDATE
                        </span>
                    {% elif row.type == 'DELETE' %}
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                            <i class="fas fa-trash mr-1"></i>DELETE
                        </span>
                    {% else %}
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                            <i class="fas fa-code mr-1"></i>OTHER
                        </span>
                    {% endif %}
                </td>
                
                <!-- 次數 -->
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                    {{ "{:,}".format(row.count) }}
                </td>
                
                <!-- 平均執行時間 -->
                <td class="px-6 py-4 whitespace-nowrap">
                    {% if row.avg_query_time > 30 %}
                        <span class="text-red-600 font-bold">{{ "%.3f"|format(row.avg_query_time) }}s</span>
                    {% elif row.avg_query_time > 10 %}
                        <span class="text-red-500 font-semibold">{{ "%.3f"|format(row.avg_query_time) }}s</span>
                    {% elif row.avg_query_time > 1 %}
                        <span class="text-yellow-600">{{ "%.3f"|format(row.avg_query_time) }}s</span>
                    {% else %}
                        <span class="text-green-600">{{ "%.3f"|format(row.avg_query_time) }}s</span>
                    {% endif %}
                </td>
                
                <!-- 使用表格 -->
                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    {% if row.tables_used %}
                        <div class="flex flex-wrap gap-1">
                            {% for table in row.tables_used[:3] %}
                                <span class="inline-flex items-center px-2 py-1 rounded-md text-xs font-medium bg-blue-50 text-blue-700">
                                    {{ table }}
                                </span>
                            {% endfor %}
                            {% if row.tables_used|length > 3 %}
                                <span class="text-xs text-gray-400">+{{ row.tables_used|length - 3 }} 更多</span>
                            {% endif %}
                        </div>
                    {% else %}
                        <span class="text-gray-400">-</span>
                    {% endif %}
                </td>
                
                <!-- 樣板 SQL -->
                <td class="px-6 py-4">
                    <div class="sql-code text-sm bg-gray-50 rounded-md p-2 max-w-md overflow-hidden">
                        <div class="truncate">{{ row.template }}</div>
                    </div>
                </td>
            </tr>
            
            <!-- 展開的詳細資訊 -->
            <tr x-show="expandedRows.includes({{ loop.index0 }})" x-transition class="bg-blue-50">
                <td colspan="6" class="px-6 py-4">
                    <div class="bg-white rounded-lg p-4 border border-blue-200">
                        <h4 class="text-sm font-medium text-gray-900 mb-2">完整 SQL 樣板</h4>
                        <div class="sql-code text-sm bg-gray-900 text-green-400 rounded-md p-3 overflow-x-auto">
                            <pre class="whitespace-pre-wrap">{{ row.template }}</pre>
                        </div>
                        <div class="mt-3 flex justify-end">
                            <button onclick="copySqlTemplate('{{ row.template|replace("'", "\\'") }}')" 
                                    class="inline-flex items-center px-3 py-2 border border-transparent text-sm leading-4 font-medium rounded-md text-blue-700 bg-blue-100 hover:bg-blue-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
                                <i class="fas fa-copy mr-1"></i>
                                複製 SQL
                            </button>
                        </div>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    {% if not data %}
    <div class="text-center py-12">
        <i class="fas fa-database text-4xl text-gray-300 mb-4"></i>
        <h3 class="text-lg font-medium text-gray-900 mb-2">目前沒有資料</h3>
        <p class="text-gray-500">請先上傳 SQL 慢查詢日誌檔案</p>
    </div>
    {% endif %}
</div>

<script>
function summaryTable() {
    return {
        expandedRows: [],
        
        toggleRow(index) {
            if (this.expandedRows.includes(index)) {
                this.expandedRows = this.expandedRows.filter(i => i !== index);
            } else {
                this.expandedRows.push(index);
            }
        }
    }
}

// 全域複製函數
function copySqlTemplate(text) {
    navigator.clipboard.writeText(text).then(function() {
        // 可以添加 toast 通知
        if (window.showToast) {
            window.showToast('SQL 已複製到剪貼板', 'success');
        } else {
            alert('SQL 已複製到剪貼板');
        }
    }, function(err) {
        console.error('複製失敗: ', err);
        // Fallback: 創建臨時文字區域進行複製
        const textArea = document.createElement('textarea');
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        
        if (window.showToast) {
            window.showToast('SQL 已複製到剪貼板', 'success');
        } else {
            alert('SQL 已複製到剪貼板');
        }
    });
}
</script> 