# SQL 慢查詢分析 Dashboard v2.0

## 🚀 功能特色

這是一個基於 **FastAPI** 開發的 MySQL 慢查詢 LOG 分析工具，採用**模組化架構**設計，提供完整的 Web 介面進行慢查詢分析。

### ✨ 主要功能

- **📊 樣板統計分析** - 自動將相似 SQL 歸類並統計執行次數和平均時間
- **📋 原始查詢列表** - 完整的慢查詢記錄，支援多條件篩選和分頁
- **📈 效能分析視覺化** - Chart.js 圖表展示各種效能指標
- **📁 多檔案管理** - 上傳、切換、刪除多個分析檔案
- **🔄 檔案合併** - 合併多個分析結果進行綜合分析
- **🏗️ 模組化架構** - 遵循單一責任原則，易於維護和擴展

### 🏛️ 架構設計

```
📁 LogSlowqueryDashboard/
├── 📄 server.py           # 主程式與路由 (僅 80 行)
├── 📄 requirements.txt    # 依賴套件
├── 📄 README.md          # 說明文件
├── 📁 core/              # 核心功能模組
│   ├── 📄 __init__.py
│   ├── 📄 log_parser.py   # LOG 解析器 (單一責任)
│   ├── 📄 sql_analyzer.py # SQL 分析器 (單一責任)
│   └── 📄 data_manager.py # 資料管理器 (單一責任)
├── 📁 api/               # API 路由模組
│   ├── 📄 __init__.py
│   ├── 📄 upload.py       # 檔案上傳 API
│   ├── 📄 analysis.py     # 分析管理 API
│   └── 📄 queries.py      # 查詢相關 API
├── 📁 models/            # 資料模型
│   ├── 📄 __init__.py
│   └── 📄 schemas.py      # 資料結構定義
├── 📁 templates/         # HTML 模板
├── 📁 static/            # 靜態資源
└── 📁 analysis_data/     # 分析資料儲存
```

### 🔧 設計原則

- **單一責任原則** - 每個模組只負責一個特定功能
- **模組化設計** - 功能分離，易於測試和維護
- **型別安全** - 使用 dataclass 定義明確的資料結構
- **錯誤處理** - 完善的異常處理機制
- **可擴展性** - 易於添加新功能和 API

## 📦 安裝與執行

### 1. 環境需求
- Python 3.8+
- pip

### 2. 安裝依賴
```bash
pip install -r requirements.txt
```

### 3. 啟動服務
```bash
python server.py
```

服務啟動後，開啟瀏覽器訪問：`http://localhost:8000`

## 📊 使用說明

### 1. 上傳 LOG 檔案
- 點擊「檔案管理」標籤
- 拖放或選擇 `.log` 或 `.txt` 檔案
- 輸入分析名稱
- 系統自動解析並產生分析報告

### 2. 查看分析結果

#### 📈 樣板統計
- 查看 SQL 樣板統計表格
- 點擊「查看原始 SQL」展開詳細資訊
- 支援排序和搜尋

#### 📋 原始查詢列表
- 完整的慢查詢記錄列表
- 支援多條件篩選：
  - 🔍 關鍵字搜尋
  - ⏱️ 查詢時間範圍
  - 🏷️ SQL 類型篩選
  - 👤 用戶篩選
  - 🗃️ 表格篩選
- 分頁顯示（每頁 50 筆）

#### 📊 效能分析
- 基本統計資訊
- SQL 類型分布圓餅圖
- 執行時間分布長條圖
- 用戶活動統計
- 表格使用頻率
- 效能比較表格

### 3. 多檔案管理
- 📁 檔案列表：查看所有分析檔案
- 🔄 快速切換：在不同分析間切換
- 🗑️ 刪除檔案：移除不需要的分析
- 🔀 合併分析：將多個分析合併為一個

## 🔧 API 文件

### 檔案上傳
- `POST /api/upload_log` - 上傳 LOG 檔案

### 分析管理
- `GET /api/analysis_files` - 取得分析檔案列表
- `POST /api/switch_analysis/{name}` - 切換分析檔案
- `DELETE /api/analysis_files/{name}` - 刪除分析檔案
- `POST /api/merge_analysis` - 合併分析檔案

### 查詢相關
- `GET /api/raw_queries` - 取得原始查詢列表（支援篩選分頁）
- `GET /api/performance_stats` - 取得效能統計資料
- `GET /api/raw_sqls/{index}` - 取得指定樣板的原始 SQL

### 系統狀態
- `GET /health` - 健康檢查

## 📋 依賴套件

```txt
fastapi>=0.104.0     # Web 框架
uvicorn>=0.24.0      # ASGI 伺服器
jinja2>=3.1.0        # 模板引擎
python-multipart>=0.0.6  # 檔案上傳支援
```

## 🏗️ 模組說明

### Core 模組

#### LogParser
- 負責解析 MySQL 慢查詢 LOG 檔案
- 提取查詢時間、用戶、表格等資訊
- 使用正規表達式精確解析

#### SQLAnalyzer  
- SQL 樣板正規化
- 查詢類型判斷
- 效能統計計算
- 建立樣板對應關係

#### DataManager
- 分析資料的載入、儲存、刪除
- 檔案管理功能
- 合併分析功能
- 資料格式轉換

### API 模組

#### upload.py
- 檔案上傳處理
- 檔案類型驗證
- 分析任務觸發

#### analysis.py
- 分析檔案管理
- 檔案切換和刪除
- 合併功能

#### queries.py
- 查詢資料 API
- 篩選和分頁
- 效能統計

### Models 模組

#### schemas.py
- 定義資料結構
- 型別安全保證
- 資料驗證

## 💡 進階功能

### 自動檔案名稱
上傳時系統會自動建議檔案名稱：`檔案名_時間戳記`

### 智慧表格篩選
支援逗號分隔的多表格篩選：`users,orders,products`

### 效能分析
提供多維度的效能分析：
- 基本統計（平均、中位數、最大值）
- SQL 類型分布
- 時間區間分布
- 用戶活動統計
- 表格使用頻率

### 合併分析
可將多個時間段的 LOG 檔案合併分析，獲得更全面的效能資訊。

## 🚀 特色亮點

1. **模組化架構** - 從 650 行單檔案重構為多模組設計
2. **型別安全** - 使用 dataclass 確保資料結構正確性
3. **單一責任** - 每個模組職責明確，易於維護
4. **完整功能** - 涵蓋上傳、分析、視覺化、管理的完整流程
5. **效能優化** - 支援大檔案處理和分頁顯示
6. **用戶友好** - 直觀的 Web 介面和豐富的互動功能

## 🤝 貢獻

歡迎提交 Issue 和 Pull Request 來改善這個工具！

## 📄 授權

MIT License